{% extends "base.html" %}

{% block title %}Help Requests{% endblock %}

{% block content %}
<section class="hf-card">
    <div class="hero">
        <p class="hf-badge">SwipeShare Dashboard</p>
        <h1>Fuel the Husker community, one swipe at a time.</h1>
        <p class="hf-muted">Browse open requests, donate spare swipes instantly, and climb the donor leaderboard.</p>
        {% if current_user %}
            <div class="hf-donor-chip">You ({{ current_user.username }}) currently hold <strong>{{ current_user.meal_swipes }}</strong> swipes.</div>
        {% else %}
            <div class="hf-donor-chip">
                You are browsing anonymously. <a href="{% url 'login' %}">Log in</a> to donate as yourself.
            </div>
        {% endif %}
    </div>
    <div class="hf-stats">
        <div class="hf-stat-card">
            <p class="hf-stat-label">Total Requests</p>
            <p class="hf-stat-value">{{ stats.total_requests }}</p>
        </div>
        <div class="hf-stat-card">
            <p class="hf-stat-label">Open Requests</p>
            <p class="hf-stat-value">{{ stats.open_requests }}</p>
        </div>
        <div class="hf-stat-card">
            <p class="hf-stat-label">Swipes Needed</p>
            <p class="hf-stat-value">{{ stats.swipes_needed }}</p>
        </div>
        <div class="hf-stat-card">
            <p class="hf-stat-label">Your Swipes</p>
            <p class="hf-stat-value">{{ stats.donor_swipes }}</p>
        </div>
    </div>
</section>

<section class="requests-toolbar">
    <input type="search" placeholder="Search by zone, need or requester..." data-filter="search">
    <select data-filter="status">
        <option value="all">All statuses</option>
        <option value="open">Open</option>
        <option value="matched">Matched</option>
    </select>
</section>

{% if requests %}
    <section class="requests-grid">
        {% for req in requests %}
            {% with status=req.status|lower %}
            <article class="hf-card request-card"
                     data-request-card
                     data-status="{{ status }}"
                     data-search-blob="{{ req.requester.username }} {{ req.need_type }} {{ req.description }} {{ req.campus_zone }} {{ req.urgency }}">
                <div class="request-meta">
                    <span class="request-status {{ status }}">{{ req.status }}</span>
                    <span>{{ req.campus_zone }}</span>
                    <span>Needed by {{ req.needed_before|date:"M d, H:i" }}</span>
                </div>
                <h3>{{ req.need_type }}</h3>
                <p class="hf-muted">{{ req.description }}</p>
                <div class="request-meta">
                    <span>Requester: <strong>{{ req.requester.username }}</strong></span>
                    <span>Urgency: <strong>{{ req.urgency }}</strong></span>
                </div>
                <div>
                    <div class="hf-progress">
                        <span style="width: {{ req.progress_pct }}%;"></span>
                    </div>
                    <p class="hf-muted small">
                        Swipes needed: <strong>{{ req.swipes_needed }}</strong>
                    </p>
                </div>
                <div class="hf-actions">
                    {% if current_user %}
                        <form method="post" action="{% url 'requests_donate' req.id %}">
                            {% csrf_token %}
                            <button type="submit" {% if req.disable_donate %}disabled{% endif %}>
                                Donate 1 Swipe
                            </button>
                        </form>
                    {% else %}
                        <a class="hf-pill" href="{% url 'login' %}">Login to donate</a>
                    {% endif %}
                </div>
            </article>
            {% endwith %}
        {% endfor %}
    </section>
{% else %}
    <div class="hf-card">
        <p>No requests found yet. Be the first to post one!</p>
    </div>
{% endif %}

{% if leaderboard %}
    <section class="hf-card leaderboard">
        <div class="hf-actions" style="justify-content: space-between; align-items: center;">
            <div>
                <p class="hf-badge">Leaderboard</p>
                <h2 class="mb-0">Top Donors</h2>
            </div>
        </div>
        <table>
            <thead>
            <tr>
                <th>#</th>
                <th>User</th>
                <th>Donation Points</th>
            </tr>
            </thead>
            <tbody>
            {% for entry in leaderboard %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ entry.username }}</td>
                    <td>{{ entry.donation_points|default:0 }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </section>
{% endif %}
{% endblock %}
